# 트랜잭션

**트랜잭션(transaction)**은 **데이터베이스의 상태를 바꾸기 위해 수행하는 작업의 단위 또는 이련의 연산** 의미. 데이터베이스의 트랜잭션은 ACID라는 특징. 이는 다음 4가지 특성의 첫글자를 딴 용어.

- **원자성(Atomicity)**  
트랜잭션이 데이터베이스에 완전히 반영되거나 아예 실행되지 않아야 한다.
- **일관성(Consistency)**   
트랜잭션 수행이 완료된 데이터베이스는 일관성이 있다.
- **독립성(Isolation)**  
수행 중인 트랜잭션에 다른 트랜잭션이 끼어들 수 없다.
- **영속성(Durability)**  
완료한 트랜잭션의 결과가 데이터베이스에 영구적으로 반영.

**원자성 때문에 트랜잭션은 완전히 반영되거나 아예 실행되지 않아야 한다.** 그래서 트랜잭션을 제어하기 위해 **TCL(Transacion Control Language)** 이라는 명령어를 사용.

TCL 종류

- **COMMIT**  
트랜잭션이 정상적으로 종료되어 데이터베이스에 변경 사항을 반영하는 명령어.
- **ROLLBACK**  
트랜잭션이 빙상적으로 종료되어 트랜잭션이 수행한 변경 사항을 취소하고 데이터 베이스를 이전 상태로 되돌리는 명령어.
- **SAVEPOINT**  
트랜잭션에서 특정 지점을 지정하는 명령어로, ROLLBACK과 함계 사용하면 해당지점까지 되돌릴 수 있다.

---

트랜잭션이 수행되는 단계와 각 단계에서 상태는 다음과 같음

- **활성화**  
트랜잭션이 시작되어 처리 중인 상태
- **부분적 완료**  
트랜잭션의 마지막 연산까지 처리가 완료되었지만 데이터베이스에 트랜잭션 수행 결과가 반영되지 않은 상태
- **완료**  
트랜잭션의 연산 처리가 완료되고 데이터베이스에 결과가 반영된 상태
- **실패**  
트랜잭션 처리 중 오류가 발생해 트랜잭션이 중단된 상태
- **철회**  
트랜잭션 중단되어 ROLLBACK을 수행해 데이터베이스를 이전으로 되돌린 상태

---

### 트랜잭션 격리

여러 트랜잭션이 서로 영향을 미치지 않고 실행될 수 있는 단계를 **트랜잭션 격리 수준(transacion isolation level)** 이라고 한다. 이는 한 트랜잭션이 다른 트랜잭션 작업의 조회 가능 여부를 결정한다.  
트랜잭션 격리 수준은 4단계

- **Read Uncommited**  
트랜잭션의 COMMIT 여부와 상관없이 다른 트랜잭션이 데이터를 조회할 수 있다.  
한 번에 여러 트랜잭션을 처리할 수 있는 동시성은 높지만, 데이터의 일관성을 유지하기 어렵다
- **Read Commited**  
트랜잭션이 COMMIT된 데이터만 다른 트랜잭션이 조회할 수 있다.
- **Repeatable Read**  
트랜잭션이 읽은 데이터를 다른 트랜잭션이 갱신하거나 삭제할 수 없다.
- **Serializable**  
트랜잭션이 읽은 데이터를 다른 트랜잭션이 갱신, 삭제, 삽입할 수 없다.

동시성이 높아지면 여러 틀내잭션이 동시에 처리되고 데이터의 일관성에 문제가 발생할 확률도 높아진다. 반면, 고립성을 높이면 하나의 트랜잭션이 처리 중일 때 다른 트랜잭션의 접근이 제한되어 효율이 낮아진다. 그러므로 상황에 따라 데이터의 일관성을 유지하면서 트랜잭션을 효율적으로 처리 할 수 있어야 한다.

# 락

**락(lock)** **트랜잭션이 처리되는 순서를 보장하기 위한 방법**. 운영체제에서 데이터 동기화를 위해 임계 영역에 대한 접근을 제한하는 상호배제 기법과 유사. 데이터의 무결성을 유지하기 위한 락이 여러 종류 있음, 대표적인 락

- **공유 락(shared lock)**  
데이터를 읽는 락으로 읽기 락(read lock)이라고도 한다. 데이터를 읽는 연산이므로 데이터의 일관성에 영향을 주지 않아 데이터에 여러 공유 락이 동시에 접근.
- **베타 락(exclusive lock)**  
데이터를 수정하는 락으로 쓰기 락(write lock)이라고 한다. 데이터의 일관성을 유지하기 위해 데이터에 하나의 베타 락이 접근 중일 때 다른 베타 락이 접근할 수 없다.

데이터베이스의 트랜잭션도 프로세스처럼 **교착 상태(deadlock)** 에 빠질 수 있다.  
이는 한 트랜잭션이 자신이 처리 중인 데이터에 대해 락을 가진 상태에서 다르 트랜잭션이 처리 중인 데이터에 대해 락을 요청해 **무한 대기 상태에 빠진 현상** 을 의미.  
즉, 특정 데이터의 락을 가지고 있는 트랜잭션이 다른 데이터의 락을 추가 요청 발생.

트랜잭션의 교착 상태 해결하기 위한 방법

1. **예방 기법**  
트랜잭션 처리가 시작되기 전에 필요한 데이텅 대해 미리 락을 얻는 방식.
2. **회피 기법**  
트랜잭션이 들어온 순서에 따라 교착 상태를 회피하는 방식.
- **wait-die**  
데이터의 락을 요청하려는 트랜잭션이 해당 데이터에 대해 이미 락을 갖고 있는 트랜잭션 보다 오래되었다면 락을 얻을 때까지 기다린다. 반면, 락을 갖고 있는 트랜잭션보다 최신이라면 락 회득 포기.
- **wound-wait**  
데이터의 락을 요청하려는 트랜잭션이 해당 데이터에 대해 이미 락을 갖고 있는 트랜잭션보다 오래되었다면 락을 빼앗는다. 반면, 락을 갖고 있는 트랜잭션보다 최신이라면 락 획득 기다린다.

# 이상

**이상(anomaly)**은 **트랜잭션을 처리하는 중에 속성 간 종속이나 데이터 중복으로 발생하는 문제.**

- **삽입 이상(insertion anomaly)**  
데이터 삽입 시 의도치 않은 다른 데이터도 삽입
- **갱신 이상(update anomaly)**  
데이터 갱신 시 일부 튜플만 갱신되어 데이터 모순이 발생
- **삭제 이상(deletion anomaly)**  
데이터 삭제 시 의도하지 않은 데이터도 삭제.

# 정규화

**정규화(normalization) 데이터베이스의 이상 현상을 해결하기 위해 테이블을 분해.**  
하지만 테이블을 분해하느라 연산 시간이 증가한다는 단점. 따라서 테이블을 무조건 분해하는 것이 아니라 상황에 따라 적절하게 정규화를 진행.  
그래야 이상 현상을 해결하고 연산 속도를 보장할 수 있다.

**정규화한 결과**를 **정규형(normal form)** 이라고 하며, 테이블을 분해하는 정도에 따라서 단계를 다음과 같이 나눌 수 있다.

**기본 정규형**

- 비정규 테이블
    - 원자 값이 아닌  속성 값 분해
- 제1정규형
    - 부분적 함수 종속 제거
- 제2형규형
    - 이행적 종속 제거
- 제3형규형
    - 결정자이면서 후보 키가 아닌 것 제거
- BC정규형
    - 다치 종속 제거

**고급 정규형**

- 제4형규형
    - 조인 종속 제거
- 제5형규형

## 제1정규형

**제1정규형(1NF, First Normal Form)**은 **테이블의 모든 속성 값이 더 이상 분해될 수 없는 값, 즉 원자 값으로 구성** 되어야 한다.   
예를 들어, 다음 그림 보면 왼쪽 테이블에 (롯데(칸쵸, 빼빼로))와 같이 ‘과자 이름’ 속성에 속성 값이 2개 존재. (오리온,(꼬북칩, 다이제))도 마찬가지로 속성 값이 2개이므로 원자 값이 되도록 테이블을 분해하는 제1정규화를 수행하면 속성 값 2개가 각각 튜플로 나눠지게 된다.  
그러면 오른쪽에 있는 제1정규형 테이블을 만들 수 있다.

| 제조사 | 과자 이름 |
| --- | --- |
| 롯데 | 칸쵸, 빼빼로 |
| 오리온 | 꼬북칩, 다이제 |
| 해태 | 홈런볼 |

| 제조사 | 과자 이름 |
| --- | --- |
| 롯데 | 칸쵸 |
| 롯데 | 빼빼로 |
| 오리온 | 꼬북칩 |
| 오리온 | 다이제 |
| 해태 | 홈런볼 |

## 제2정규형

**제2정규형(2NF, Second Normal Form)** 은 제1정규형에 속하는 테이블에서 **부분적 함수 종속을 제거** 해 완전 함수 종속을 만족. **함수 종속성** 은 테이블에서 속성 간 종속 관계 의미.  
예를 들어, A 속성이 B 속성을 결정하면 B 속성이 A 속성에 ㅎ마수 종속된다고 하고, A를 **결정자** , B를 **종속사** 라고 한다. **완전 함수 종속**은 A 속성이 B 속성을 결정하지만, A 속성의 진부분집합이 B 속성을 결정하지 않는 경우 의미.  
따라서 **부분적 함수 종속** 은 기본 키의 부분집합이 결정자가 될 수 있음을 의미.  
즉, **기본 키의 진부분집합이 결정자가 될 수 없도록 테이블을 분해해야 완전 함수 종속을 만족**.

예를 들어, 제조사에 따라 과자의 판매처가 정해진다고 가정. 제조사가 롯데인 경우 롯데마트에서만 판매, 그 외 제조사 제품은 이마트에서만 판매. 그 외 제조사 제품은 이마트에서만 판매.  
다음 테이블에서 기본 키는 ‘제조사’와 ‘과자 이름’ 속성. 가격 속성은 제조사와 과자 이름으로 정해지지만, 판매처는 제조사로만 정해진다. 즉, 기본 키의 부분 집합인 제조사가 판매처를 결정하는 결정자가 된다. 따라서 이를 제2정규화.

| 제조사 | 과자 이름 | 가격 | 판매처 |
| --- | --- | --- | --- |
| 롯데 | 칸쵸 | 2000 | 롯데마트 |
| 롯데 | 빼빼로 | 1200 | 롯데마트 |
| 오리온 | 꼬북칩 | 1300 | 이마트 |
| 오리온 | 다이제 | 1500 | 이마트 |
| 해태 | 홈런볼 | 1000 | 이마트 |

| 제조사 | 과자 이름 | 가격 |
| --- | --- | --- |
| 롯데 | 칸쵸 | 2000 |
| 롯데 | 빼빼로 | 1200 |
| 오리온 | 꼬북칩 | 1300 |
| 오리온 | 다이제 | 1500 |
| 해태 | 홈런볼 | 1000 |

| 제조사 | 판매처 |
| --- | --- |
| 롯데 | 롯데마트 |
| 롯데 | 롯데마트 |
| 오리온 | 이마트 |
| 오리온 | 이마트 |
| 해태 | 이마트 |

판매처에 대한 테이블을 분리해 완전 함수 종속 만족.

---

**부분집합**  
집합 A의 모든 우너소가 집합 B에 포함될 때 집합 A를 집합 B의 부분집합.

**진부분집합**  
집합 A가 집합 B의 부분집합이면서 집합 B와 같지 않을 때 집합 A를 집합 B의 진부분집합.

---

## 제3정규형

**제3정규형(3NF, Third Normal Form)** 은 제2정규형에 속하는 테이블에서 **이행적 종속이 없어야** 한다. **이행적 종속** 은 A 속성이 B 속성을 결정, B 속성이 C 속성을 결정할 때 A 속성이 C 속성을 결정하는 것을 의미. 이런 경우 A 속성이 C 속성을 결정하는 이행적 종속을 제거. 즉, A 속성이 B 속성을 결정하는 테이블과, B 속성이 C 속성을 결정하는 테이블로 분해.

고객 한 명당 과자 하나만 구매할 수 있다는 전제

| 고객 | 과자 이름 | 구매 금액 |
| --- | --- | --- |
| 김XX | 칸쵸 | 2000 |
| 이XX | 다이제 | 1500 |
| 최XX | 꼬북칩 | 1300 |
| 임XX | 칸쵸 | 2000 |

이 테이블에서 이행적 종속은 다음과 같음.  
과자 이름은 고객이 구매한 과자로 결정. 과자 이름은 가격을 결정. 고객 한 명당 과자를 하나만 구매할 수 있으므로 고객이 가격을 정하는 것처럼 종속 관계를 갖게 됨. 

예를 들어, 칸쵸 금액 인상 칸쵸를 구매한 일부 고객의 구매 금액만 갱신되면 갱신 이상 발생.  
따라서 이행적 종속을 제거하고 정규화.

| 고객 | 과자 이름 |
| --- | --- |
| 김XX | 칸쵸 |
| 이XX | 다이제 |
| 최XX | 꼬북칩 |
| 임XX | 칸쵸 |

| 과자 이름 | 구매 금액 |
| --- | --- |
| 칸쵸 | 2000 |
| 다이제 | 1500 |
| 꼬북칩 | 1300 |
| 칸쵸 | 2000 |

## 보이스-코드 정규형

**보이스-코드 정규형(BCNF, Boyce-Codd Normal Form)** 은 강한 제3정규형이라고 함, 제3정규형에 속하는 테이블의 **모든 결정자가  후보 키가 되도록 테이블을 분해**

예를 들면 학번과 과목을 기본 키로 교수 속성 값을 결정. 하지만 교수는 과목 속성을 결정하는 결정자이기도 하다. 따라서 결정자가 후보 키가 아니므로 BCNF를 만족하지 못함.

| 학번 | 과목 | 교수 |
| --- | --- | --- |
| 2024111111 | 데이터베이스 | 김XX |
| 2024222222 | 네트워크 | 신XX |
| 2024333333 | 알고리즘 | 이XX |
| 2024444444 | 네트워크 | 신XX |

이 테이블에 BCNF 정규화를 진행하면 결과

| 학번 | 과목 |
| --- | --- |
| 2024111111 | 데이터베이스 |
| 2024222222 | 네트워크 |
| 2024333333 | 알고리즘 |
| 2024444444 | 네트워크 |

| 과목 | 교수 |
| --- | --- |
| 데이터베이스 | 김XX |
| 네트워크 | 신XX |
| 알고리즘 | 이XX |

---

### 제4정규형

제4정규형(4NF, Fourth Normal Form)제3정규형에 속하면서 **다치 종속을 제거** 해야 한다.  
**다치 종속** 은 테이블에서 한 속성이 여러 속성 값 결정하는 것 의미.

다음 예에서 왼쪽 테이블을 제3정규화까지 진행하면 오른쪽 테이브링 됨.  
오른쪽 테이블에서는 학생이 전공과 취미라는 두 가지 속성을 결정. 즉, 다치 종속 존재.

| 학생 | 전공 | 취미 |
| --- | --- | --- |
| 김XX | 컴퓨터공학 | 기타 |
| 이XX | 전자 공학, 컴퓨터 공학 | 드럼, 피아노 |

| 학생 | 전공 | 취미 |
| --- | --- | --- |
| 김XX | 컴퓨터공학 | 기타 |
| 이XX | 전자 공학 | 드럼 |
| 이XX | 전자 공학 | 피아노 |
| 이XX | 컴퓨터 공학 | 드럼 |
| 이XX | 컴퓨터 공학 | 피아노 |

다치 종속을 제거하려면 다음과 같이 학생 전공을 결정하는 테이블과 학생이 취미 결정하는 테이블로 각각 분해

| 학생 | 전공 |
| --- | --- |
| 김XX | 컴퓨터공학 |
| 이XX | 전자 공학 |
| 이XX | 컴퓨터공학 |

| 학생 | 취미 |
| --- | --- |
| 김XX | 기타 |
| 이XX | 드럼 |
| 이XX | 피아노 |

### 제5정규형(5NF)

제5정규형(5NF, Fifth Normal Form)은 제4정규형에 속하면서 **조인 종속이 없어야** 한다. 조인 종속 없다는 것은 테이블을 분해했다가 조인할 때 테이블이 복원된다는 것을 의미.

---

### 역정규화

**역정규화(denormalization)** 정규화된 테이블을 낮은 정규화 단계의 테이블로 되돌리는 것, 읽기 성능 향상시킬 때 사용. 정규화를 수행하면 테이블이 분해되므로 필요한 결과 데이터를 얻기 위해 조인 연산 여러 번 수행. 이 때문에 데이터베이스를 빈번히 조회하는 경우 성능 저하가 생길 수 있다. 그래서 오히려 중복을 허용하는 역정규화 수행

---